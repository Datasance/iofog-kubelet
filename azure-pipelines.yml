trigger:
  tags:
    include:
      - v*
  branches:
    include:
      - develop
      - release*
  paths:
    exclude:
      - README.md

pr: none

variables:
  repository: 'focal-freedom-236620/kubelet'
  build: $(Build.BuildId)
  rc_version: 1 # Manually update this on your release branches as necessary. Should always be 1 on develop branch
  version:

jobs:
  - job: Platform
    dependsOn: Kubelet
    pool: server
    variables:
      tag: b-$(buildTag)

    steps:
      - task: InvokeRESTAPI@1
        displayName: 'trigger platform job'
        inputs:
          connectionType: 'connectedServiceName'
          serviceConnection: 'Pipelines'
          method: 'POST'
          urlSuffix: '/edgeworx/_apis/build/builds?api-version=5.0'
          body: "{\"Parameters\":\"{\\\"images.kubelet\\\": \\\"gcr.io/$(repository):$(tag)\\\"}\", \"Definition\":{\"id\":\"5\"}}"
          waitForCompletion: 'false'

  - job: Kubelet
    pool:
      vmImage: 'Ubuntu-16.04'

    steps:
      - script: |
          if [[ $(ref) == refs/heads/release* ]]; then
            RCVERS=$(echo $(ref) | sed "s|refs/heads/release/||g")
            echo "##vso[task.setvariable variable=version]$RCVERS-rc$(rc_version)"
          elif [[ $(ref) == refs/tags* ]]; then
            TAG=$(echo $(ref) | sed "s|refs/tags/v||g")
            echo "##vso[task.setvariable variable=version]$TAG"
          else
            LATESTTAG=$(git tag | tail -1)
            LATESTVERS=${LATESTTAG#?}
            if [ -z "$LATESTVERS" ]; then LATESTVERS=0.0.0; fi
            echo "##vso[task.setvariable variable=version]$LATESTVERS-b$(build)"
          fi
          echo $(version)
      displayName: 'Set version variable'

      - task: Docker@2
        displayName: 'docker build and push'
        inputs:
          containerRegistry: 'Edgeworx GCP'
          repository: $(repository)
          command: 'buildAndPush'
          Dockerfile: 'Dockerfile'
          tags: |
            $(version)
            latest
